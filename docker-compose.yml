version: "3.9"
services:
  nginx:
    image: rgolea/baneverywhere-proxy:latest
    container_name: baneverywhere-nginx
    ports:
      - "80:80"
    depends_on:
      - api

  api:
    image: rgolea/baneverywhere:latest
    command: node apps/api/main.js
    container_name: api-baneverywhere
    stdin_open: true
    tty: true
    restart: unless-stopped
    expose:
      - 3333
    environment:
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_HOST=${REDIS_HOST}
      - JWT_SECRET=${JWT_SECRET}
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
      - TWITCH_CLIENT_SECRET=${TWITCH_CLIENT_SECRET}
    depends_on:
      - mongodb
      - redis

  bot:
    image: rgolea/baneverywhere:latest
    command: node apps/bot/main.js
    container_name: bot-baneverywhere
    stdin_open: true
    tty: true
    restart: unless-stopped
    environment:
      - BAN_BOT_USER=baneverywhere
      - TWITCH_CLIENT_ACCESS_TOKEN=${TWITCH_CLIENT_ACCESS_TOKEN}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_HOST=${REDIS_HOST}
    depends_on:
      - redis

  bot-handler:
    image: rgolea/baneverywhere:latest
    command: node apps/bot-handler/main.js
    container_name: bot-handler-baneverywhere
    stdin_open: true
    tty: true
    restart: unless-stopped
    environment:
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_HOST=${REDIS_HOST}
      - MONGODB_URI=${MONGODB_URI}
    depends_on:
      - redis
      - mongodb
  online-checker:
    image: rgolea/baneverywhere:latest
    command: node apps/online-checker/main.js
    container_name: online-checker-baneverywhere
    stdin_open: true
    tty: true
    restart: unless-stopped
    environment:
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_HOST=${REDIS_HOST}
      - MONGODB_URI=${MONGODB_URI}
    depends_on:
      - redis
      - mongodb

  queue-processor:
    image: rgolea/baneverywhere:latest
    command: node apps/queue-processor/main.js
    container_name: queue-processor-baneverywhere
    stdin_open: true
    tty: true
    restart: unless-stopped
    environment:
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_HOST=${REDIS_HOST}
      - MONGODB_URI=${MONGODB_URI}
    depends_on:
      - redis
      - mongodb

  mongodb:
    image: mongo:5.0.4
    container_name: mongodb-baneverywhere
    restart: unless-stopped
    entrypoint: ["/usr/bin/mongod", "--bind_ip_all", "--replSet", "rs0"]

  redis:
    image: redis:6.2.6
    container_name: redis-baneverywhere
    restart: unless-stopped
    command: redis-server
